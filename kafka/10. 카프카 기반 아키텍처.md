# 카프카 기반 아키텍처

### 카카오 스마트 메시지 서비스

- 소재 최적화와 유저 타게팅을 통해 적합한 유저에게 광고 메시지를 개인화 전송하는 서비스
- [카카오 스마트 메시지 서비스 아키텍처](https://if.kakao.com/session/22)
  ![스마트 메시지 서비스 아키텍처.png](img/section10/스마트%20메시지%20서비스%20아키텍처.png)

***
### 스마트 메시지의 카프카 스트림즈 활용

![스마트 메시지의 카프카 스트림즈 활용.png](img/section10/스마트%20메시지의%20카프카%20스트림즈%20활용.png)

- 사용자의 반응 로그(imp, click)을 취합하여 저장하고 유저 데이터를 매핑 처리하는 용도로 카프카 스트림즈 활용
- 카프카 스트림즈의 groupByKey, windowedBy, aggregate 구문을 통해 1분 로그를 window 취합하여 적재, map 구문을 통해 Redis의 유저 데이터와 결합 처리 하는 로직 수행

***
### 넷플릭스 키스톤 프로젝트

- Fronting Kafka : 라우팅 용도로 모든 데이터 수집
- Router : 두번째 카프카 또는 하둡(배치 적재), 엘라스틱 서치(실시간 적재)와 같은 데이터베이스로 전달
- 카프카 클러스터를 구분함으로서 목적에 맞는 카프카 클러스터 설정 가능

***
### 라인 쇼핑 플랫폼

![라인 쇼핑 플랫폼.png](img/section10/라인%20쇼핑%20플랫폼.png)

- 시스템 유연성을 개선하고 처리량에 한계를 없애기 위해 카프카를 중앙에 위치한 아키텍처
- 카프카 커넥트 도입. mongodb CDC(Change Data Capture) 커넥터 활용
- 이벤트 기반 데이터 처리로 상품 처리가 매우 빨라짐
- [라인 쇼핑 플랫폼](https://engineering.linecorp.com/ko/blog/line-shopping-platform-kafka-mongodb-kubernetes/)

***
### 11번가 주문/결제 시스템

![11번가 주문-결제 시스템.png](img/section10/11번가%20주문-결제%20시스템.png)

- 데이터베이스의 병목현상 해소를 위해 도입
- 카프카를 단일 진실 공급원(Source of Truth) 로 정의
- 메시지를 Materalized View 로 구축하여 배치 데이터처럼 활용
- [11번가 주문/결제 시스템](https://deview.kr/2019/schedule/305)

***
### 카프카 기술 별 아키텍처 적용 방법 정리(우선순위 나열)

1. 카프카 커넥트
    - 반복적인 파이프 라인을 만들어야 할 경우 분산 모드 커넥트 로 운영
    - 되도록 오픈소스 커넥터 사용하되, 필요시 커스텀 커넥터 개발하여 운영
    - REST API와 통신하여 동작할 수 있는 오픈소스 활용

2. 카프카 스트림즈
    - 강력한 stateful 프로세싱 : 윈도우 프로세싱 기능으로 데이터 취합 처리 가능
    - 강력한 stateless 프로세싱 : 실시간 데이터 처리 가능
    - 카프카 토픽으로 이벤트 스트리밍 처리 시 선택

3. 카프카 컨슈머, 프로듀서
    - 커넥트와 스트림즈로 구현할 수 없거나 단일성 파이프라인, 개발일 경우에 컨슈머 또는 프로듀서로 개발

***
### 카프카 기술 아키텍처 구조

![카프카 기술 아키텍처 구조.png](img/section10/카프카%20기술%20아키텍처%20구조.png)

- 프로듀서를 통해 데이터 최초 유입
- 토픽 기반 데이터 프로세싱은 카프카 스트림즈로 처리
- 반복된 파이프라인은 카프카 커넥트에서 처리
- 단발 처리는 컨슈머 서비스 개발

